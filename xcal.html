<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>XCalibur Sequence Generator</title>
    <style>
		
		*{
            box-sizing: border-box;
			font-family: 'Helvetica', sans-serif;
        }
        
         html, body{
            
            margin: 0;
            height: 100%;
            width: 100%;
             -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }
		
		input:focus{
			
			outline: 2px solid black
		}
		
		input[type="number"]{
		    
		    width:3em;
		}
		
		button{
		    
		    padding:2px;
		}
		
		body.drag_active{
			
			cursor: grabbing;
		}
		
		.plate{
			
			background: #e6e6e6;
			display: table;
			margin:0px auto;
			margin-bottom: 70px;
			position: relative;
		}
		
		.plate::last-child{
			
			margin-bottom: 0px;
		}
		
		.plate::before{
			
			content:'sample count: ' attr(data-sample-count);
			position: absolute;
			bottom: 102%;
			right:0;
			font-weight: bold;
		}
		
		.plate::after{
			
			content: 'well count: ' attr(data-select-well-count);
			position: absolute;
			left:0;
			bottom: 102%;
			font-weight: bold;
		}
		
		.well{
			
			display: inline-block;
			cursor: pointer;
			width: 50px;
			height: 50px;
			margin: 10px;
			border-radius: 50px;
			background: white;
			position: relative;
			font-size: 12px;
			border:4px solid transparent;
			position: relative;
			user-select: none;
			-webkit-user-select:none;
		}
		
		.plate.show_names .well[data-samplename]::after, .well[data-samplename]:hover::after{
			
			content:attr(data-samplename) "\A \A ( " attr(data-inject-count) " )";
			position: absolute;
			bottom: 30%;
			left: 50%;
			
			background: #575757;
			color:white;
			min-width: 7.8em;
			padding: 1px;
			line-height: 1em;
			font-size: 8px;
			text-align: center;
			
			transform: translateX(-50%);
			
			z-index: 50;
			white-space: pre-wrap;
			word-break: break-all;
			
			webkit-box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.34);
			-moz-box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.34);
			box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.34);
			opacity: 0.9;
		}
		
		.well.selected[data-samplename]::after{
			
			background: black !important;
			opacity: 1 !important;
		}
		
		.well.selected.last[data-samplename]::after{
			
			background: blue !important;
		}
		
		.well .indicator{
			
			position: absolute;
			top:50%;
			left: 50%;
			padding: 4px;
			text-align: center;
			transform: translate(-50%, -50%);
			border-radius: 30px;
		}
		
		.plate.show_names .well[data-samplename] .indicator{
			
			position: absolute;
			top:90%;
			font-size: 8px;
		}
		
		.well[data-samplename] .indicator{
			
			color: white;
		}
		
		.well[data-samplename]:hover::after{
			
			min-width: 12em;
			bottom: 100%;
		}
		
		.well.selected{
			
			border-color:black;
		}
		
		.well.selected.last{
			
			border-color:blue;
		}
		
		.well.selected.last .indicator{
			
			color:blue;
		}
		
		.well[data-inject-count="1"] .indicator{
			
			background: black;
			color:white;
		}
		
		.well[data-inject-count="2"] .indicator{
			
			background: red;
			color:white;
		}
		
		.well[data-inject-count="3"] .indicator{
			
			background: #00ceff;
			color:white;
		}
		
		.well.multi_inject .indicator{
			
			background: #ff00f5 !important;
			color:white;
		}
	
		.injection_list{
			
			border-collapse: collapse;
			min-width: 300px;
			user-select: none;
			-webkit-user-select: none;
		}
		
		.injection_list:focus{
			
			outline: none;
		}
		
		.injection_list.collapsed td{
			
			padding-bottom: 2px;
			padding-top: 2px;
		}
		
		.injection_list input[type="number"]{
			
			width: 3em;
		}
		
		#inj_area{
			
			position: fixed;
			height: 100%;
			right:0px;
			transition: right 0.3s;
			top:0;
			border-left: 1px solid transparent;
			background: #efefef;
			width: 450px;
		}
		
		#inj_area:focus-within{
			
			background: white;
			 -webkit-box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.2);
            -moz-box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.2);
            box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.2);
			border-left: 1px solid black;
		}
		
		#inj_area:focus{
			
			outline: none;
		}
		
		.inj_container{
			
			position: absolute;
			height: calc(100% - 140px);
			top:140px;
			overflow:scroll;
			width: 100%;
			padding:10px 2px;
		}
		
		.control_bar{
			
			position: absolute;
			top:0;
			width: 100%;
			left: 0;
			background: #c7c5c5;
			height: 140px;
			padding: 10px;
			font-size: 14px;
			overflow: hidden;
		}
		
		.control_bar .top_section{
			
			position: absolute;
			top:10px;
			transition: all 0.3s;
		}
		
		.control_bar.show_lower .top_section{
			
			position: absolute;
			top:-37px;
		}
		
		.control_bar .row{
			
			padding-bottom: 12px;
			margin-bottom: 12px;
			border-bottom: 1px solid black;
		}
		
		.control_bar .row:last-child{
			
			border-bottom:none;
		}
		
		.control_bar > div:last-child{
			
			border-bottom: none;
		}
		
		.control_bar input{
			
			margin-right: 25px;
		}
		
		.row button{
			
			margin-right: 8px;
		}
		
		.timepoint{
			
			font-weight: bold;
			padding: 3px;
		}
		
		#seq_start_time:focus{
			
			color:blue;
			outline: none;
		}
		
		#seq_start_time:hover{
			background: #e6e6e6;
			cursor: pointer;
		}
		
		.inj_container table{
			
			width: 100%;
		}
		
		th, td{
            
            padding:8px;
            padding-right: 10px;
            min-width: 30px;
            max-width: 60px;
        }
		
		td.sample_name{
			
			min-width: 200px;
			max-width: 300px;
			color: white;
			word-break: break-all;
		}
        
        th{
            
            padding-bottom: 15px;
            border-bottom: 2px solid black;
            vertical-align: center;
        }
        
        td{
            
            padding-bottom:10px;
            vertical-align: top;
            border-bottom: 1px solid #d8d8d8;
			font-size: 14px;
        }
		
		tr.selected {
			
			color: #1830b7;
			background: #f2f2f2;
		}
		
		tr.selected .index{
			
			color: #1830b7;
		}
		
		tr.selected input {
			
			color: #1830b7;
		}
		
		td.index{
			
			font-size: 11px;
			min-width: 2em !important;
			width: 2em;
			padding: 4px;
			padding-top: 5px !important;;
			color:gray;
		}
		
		.well_selector{
			
			background: #cecece;
			cursor: pointer;
			display: table;
			position: fixed;
			z-index: 100;
			border:1px solid #454545;
			pointer-events: none;
			visibility: hidden;
		}
		
		.well_selector.visible{
			
			
			visibility: visible;
			pointer-events: all;
		}
		
		.well_option{
			
			display: inline-block;
			width: 30px;
			height: 30px;
			line-height: 30px;
			text-align: center;
			background: white;
			position: relative;
			font-size: 15px;
			color: #a5a5a5;
		}
		
		.well_option.selected{
			
			background: #cc282e;
			color: white;
		}
		
		.well_option:hover{
			
			color: black;
			font-weight: bold;
			background: #c9c9c9;
		}
		
		.well_option:active{
			
			background: #646464;
			color: white;
		}
		
		.well_selector_input{
			
			display: inline-block;
			width: 40px;
			height: 16px;
			cursor: pointer;
		}
		
		.well_selector_input:hover{
			
			background: #e5e5e5;
			outline: 5px solid #e5e5e5;
			font-weight: bold;
		}
		
		#DRAG_ROW{
			
			pointer-events: none;
			position: fixed;
			 -webkit-box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.4);
            -moz-box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.4);
            box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.4);
			background: white;
			opacity: 0.8;
		}
		
		.injection.moving td{
			
			opacity: 0 !important;
		}
		
		.injection.moving{
			
			background: white;
		}
		
		#plate_area{
			
			position: fixed;
			top:0;
			height: 100%;
			width: calc(100% - 450px);
			left:calc(50% - 225px);
			transform: translateX(-50%);
		}
		
		#plate_container{
			
			position: absolute;
			top:150px;
			left: 0;
			padding: 40px;
			overflow: scroll;
			width: 100%;
			height: calc(100% - 150px);
		}
		#sample_name_input{
			
			width: 24em;
		}
		
		#help_section{
			
			position: fixed;
			overflow: scroll;
			z-index: 1000;
			width: 100%;
			height: 100%;
			top:0;
			left: 0;
			background: #dbdbdb;
			font-size: 13px;
			opacity: 0.95;
			padding: 40px;
			opacity: 0;
			pointer-events: none;
		}
		
		#help_section.visible{
			
			opacity:1;
			pointer-events: all;
		}
		
		#help_section li{
			
			padding: 5px;
		}
		
		#copytext{
			
			position: fixed;
			top:-1000px;
		}
		
		
		#exp_edit_panel{
			
			position: fixed;
			display: none;
			top:10px;
			left: 220px;
			
			font-size: 13px;
			font-weight: bold;
			background: white;
			border: 1px solid black;
			text-align: right;
			width: 700px;
			padding: 10px;
		}
		
		#exp_id_selector{
			
			width: 10em;
		}
		
		#exp_edit_panel.visible{
			
			display: block;
			webkit-box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.2);
			-moz-box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.2);
			box-shadow: 0px 3px 12px 0px rgba(0,0,0,0.2);
		}
		
		#exp_edit_input{
			
			display: inline-block;
			background: #e3e3e3;
			width: calc(100% - 23em);
			padding: 3px;
			border-radius: 3px;
			font-weight: bold;
			font-size: 13px;
			word-break: break-all;
		}
		
		#exp_edit_input:hover{
			
			color: #2c2ccc;
			cursor: pointer;
		}
		
		#exp_edit_panel input{
			
			width: calc(100% - 14em);
			padding: 0.2em;
		}
		
		#exp_edit_panel div{
			
			margin-bottom: 4px;
		}
		
		#help_bttn{
			
			position: fixed;
			top:0;
			left: 100%;
			width: 70px;
			height: 70px;
			background: red;
			z-index: 1002;
			transform:translate(-50%, -50%) rotateZ(45deg);
			cursor: pointer;
			user-select: none; 
			-webkit-user-select:none;
		}
		
		#help_bttn::after {
			position: absolute;
			content: "?";
			top: 62%;
			left: 42%;
			color: white;
			font-size: 26px;
			font-weight: bold;
			transform: rotateZ(-45deg);
		}
		
		#help_bttn:hover::before{
			position: absolute;
			content: "toggle help manual";
			word-break: keep-all;
			top: 141%;
			left: -77%;
			color: white;
			padding: 4px;
			background: black;
			font-size: 12px;
			transform: rotateZ(-45deg);
		}
		
		#toggle_ctrl_bar{
			
			position: absolute;
			right: 0px;
			top:102px;
			width: 30px;
			height: 30px;
			line-height: 30px;
			background: #c7c7c7;
			text-align: center;
			user-select: none; 
			-webkit-user-select:none;
			cursor: pointer;
		}
		#toggle_ctrl_bar:hover::after{
			
			color:red;
		}
		
		#toggle_ctrl_bar::after{
			
			content:'▲'
		}
		
		#toggle_ctrl_bar.on::after{
			
			content:'▼'
		}
		
		#toggle_ctrl_bar:hover::before{
			position: absolute;
			content: "toggle injection time";
			word-break: keep-all;
			bottom: 105%;
			width: 100px;
			right: 50%;
			color: white;
			padding: 4px;
			background: black;
			font-size: 12px;
			line-height: 12px;
		}
		
		#status_bar{
	
			font-weight: lighter;
			letter-spacing: 0.5px;
			color:white;
			padding:1em;
			font-size: 14px;
			width: 100%;
			margin-bottom: 0.5em;
			position: fixed;
			top:-50px;
			-webkit-transition: top 0.2s;
			transition: top 0.2s;
			z-index: 100000;
		}

		#status_bar.show{

			top:0px;
		}

		#status_bar.success{

			background: #4aa24a;
		}

		#status_bar.error{

			background: #af4949;
		}
		
		@media print{
			
			
			#inj_area{
				
				display: none;
			}
			
			#plate_area{
				
				left: 0;
				width:100%;
				position: absolute;
				transform: none;
				display: block;
				height: auto;
				overflow: visible;
			}
			
			#exp_edit_panel{
				
				display: none;
			}
			
			#help_bttn{
				
				display: none;
			}
			
			#plate_container{
				
				top:0;
				display: block;
				width: 100%;
				height: auto;
				overflow: visible;
			}
			
			.plate{
				
				page-break-inside: avoid;
				break-inside:avoid;
			}
			
			.plate::before {
			   page-break-inside: avoid;
				break-inside:avoid;
			}
			
			.plate::after{
				
				display: none;
			}
			
			.well{
				
				width: 45px;
				height: 45px;
				margin: 5px;
			}
			
			.well::after{
				
				font-size: 5px !important;
			}
			
			#plate_area .control_bar{
				
				display: none;
			}
			
			#exp_edit_panel{
				
				display: none !important;
			}
		}
		
	</style>
</head>
<body>
<div id = "plate_area" tabindex="0">

	<div class = "control_bar">
	
		<div class = "row">
			experiment: <select  id = "exp_id_selector" style="margin-right: 10px"></select>
				<span id="exp_edit_input" data-id="0">asparagine/20200725/krall/UC13glucose-MCF10A-cells</span>
				<button id = "clone_exp_bttn">clone</button>
		</div>
		<div class = "row">
			
			sample name: <input id = "sample_name_input" type="text" placeholder="{D}-sample-{2*# + 1}" style="margin-right:0" maxlength="70">
			<button id = "add_sample_bttn" style="margin-right: 20px">add</button>
			dynamic selection: <input id="move_select_post_add" type="checkbox" checked>
			show sample names:<input id="show_sample_names" type="checkbox"  style="margin-right:0">
		</div>
		insert mode:
			<select  id = "ins_mode_input" style="margin-right: 20px">
				<option>replace</option>
				<option>before</option>
				<option>after</option>
			</select>
		search: <input id = "search_input" type="text" placeholder="gLucxosee"> 
		insert: <input id = "insert_input" type="text"  placeholder="glucose"  style="margin-right:0"> 
		<button id = "insert_bttn" style="margin-right:25px">insert</button>
	</div>
	<div id = "plate_container"></div>
</div>
<div id = "exp_edit_panel">
	<div>project: <input id = "pi" type="text"></div>
	<div>date: <input id = "di" type="text"></div>
	<div>experimentor lastname: <input id = "eli" type="text"></div>
	<div>experiment title: <input id = "eti" type="text"></div>
	<div>output folder path: <input id = "ofpi" type="text"></div>
	<div>method file path: <input id = "mfpi" type="text"></div>
</div>

 <div id = "inj_area" tabindex="0">
 	<div class = "control_bar" style="user-select: none; -webkit-user-select:none">
 	<div class = "top_section">
 		<div class = "row">
 			insert mode:
			<select  id = "inj_mode_input" style="margin-right: 20px">
				<option>end</option>
				<option>start</option>
				<option>before selection</option>
				<option>after selection</option>
			</select>
			count: <span id = "inj_count" style="font-weight: bold;"></span>
		</div>
		<div class = "row">
			<button id = "set_epxid_bttn">set experiment id</button> : <input id = "exp_id_input" type = "number" min = "0" max = "99" value="0">
			<button id = "set_vol_bttn">set volume</button> : <input id = "vol_input" type = "number" min = "1" max = "20" value="10">
 		</div>
 		<div class="row">
 			<button id="select_all_bttn">select all</button> <button id="clr_select_bttn">clear selection</button> <button id="delete_bttn">delete selection</button> <button id="download_bttn">download selection</button>
 		</div>
 		<div class="row">
 			min per inj:<input id = "min_per_inj_input" type="number" value="30" min="0" max="99"> start:<span class = "timepoint" id = "seq_start_time" tabindex="1" style="margin-right: 20px;">Fri 11:30pm</span> end:<span class = "timepoint" id = "seq_end_time">Sat 10:00am</span>
 		</div>
 	</div>
 	</div>
 	 <div class="inj_container"></div>
 </div>
 
 <div id = "help_bttn"></div>
  <div id = "toggle_ctrl_bar" ></div>
 
 
 <div id = "help_section">
	<h1>General Help</h1>
 	<ul>
 	 	<li>White wells contain no samples. Once a well has a sample it will be filled with a color. Replicate samples have the same color. To view the sample name either hover over a well or click the show sample names checkbox. Either of these actions will bring up text above the well which indicates the sample name and the number of injections from that well in parentheses. Any well that has been added to the injection list will have a colored dot underneath its location text. Black = 1 injection. Red = 2 injections. Blue = 3 injections. Pink = > 3 injections.</li>
 		<li>Click on wells to toggle their selection. Dragging the mouse over an unselected well will cause it to be selected. To cancel all well selections use the escape key. The last selected well is shown in blue and is the target of any copy/paste operations.</li>
 		<li>The sample name input field supports "smart expressions" that consist of special characters. Use {D} to insert the current date as a string. Use {#} to denote the index of the sample/replciate. This character supports mathematical operations such as {2*# + 5}, {10 - #*2}. When evaluated, the final number inserted into the sample name will be the result of the original index altered by the function.</li>
 		<li>Use the input fields below the sample name entry to edit sample names. You can replace any text or insert new text before or after any search term. These changes will apply to all sample names even if they are not selected. Any changes made to sample names on the plate will automatically be reflected in the sample names of the corresponding injections.</li>
 		<li>The dynamic selection option, which is enabled by default, causes the selection on a plate to auto-migrate right and downard anytime samples are added or injected.</li>
 		<li>When injecting samples, the new injections will be assigned the experiment id that is currently displayed in the top bar.</li>
 		<li>Use the top left drop down menu to select a different experiment. To edit the currently selected experiment click the top experiment info bar to reveal an edit form. To copy the currently selected experiment and add it as an option at the end of the list click the clone button to the right of the experiment info bar. </li>
 		<li>Once added injections can be deleted, dragged to a new position, or edited. Click on the well position inside an injection to bring up a well selector. Use the top bar above the injections to alter either their injection volumes or their experiment id.</li>
 	</ul>
 	<h1>Keyboard Shortcuts</h1>
 	<ul>
 		<li><b>esc:</b> clear selection</li>
 		<li><b>delete/backspace:</b> delete selected samples or injections</li>
 		<li><b>click + Shift:</b> select all items between closest selected item and clicked item. Works on wells and injections.</li>
 		<li><b>Shift + A:</b> select all injections</li>
 		<li><b>Shift + (+):</b> duplicate selected injections</li>
 		<li><b>Shift + (Enter):</b> inject samples from selected wells</li>
 		<li><b>Shift + (delete):</b> delete injections from selected wells</li>
		<li><b>Shift + T:</b> toggle dynamic selection</li>
 		<li><b>Ctrl + c:</b> copy the sample name from the most recently selected well in blue</li>
 		<li><b>Ctrl + v:</b> paste text into most recently selected well in blue. Multiple lines in the paste text will result in each line used as the name for a new sample.</li>
 		<li></li>
 		<li><b>Enter (while sample name has focus):</b> add new sample to selected wells</li>
 		<li><b>Enter (while insert text has focus):</b> alter the names of all selected samples according to the set pattern</li>
 	</ul>
 </div>
 <input id="copytext" type="text">
  <div id = "status_bar"></div>
 <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous">
	</script>
	 <script src = "https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.2.0/papaparse.min.js"></script>
<script>
	
	String.prototype.replaceAllEWS = function(find, replace) {
		let s = '', index, next;
		while (~(next = this.indexOf(find, index))) {
		  s += this.substring(index, next) + replace;
		  index = next + find.length;
		}
		return s + this.substring(index);
	  };
	
	const STATUS_BAR = $('#status_bar');

		function FLASH_STATUS_BAR(status, message){

			if(status == 'error'){

				STATUS_BAR.removeClass("success");
				STATUS_BAR.addClass("error");
			}
			else if(status == 'success'){

				STATUS_BAR.removeClass("error");
				STATUS_BAR.addClass("success");
			}

			STATUS_BAR.addClass("show");
			STATUS_BAR.html(message);

			setTimeout(function(){ STATUS_BAR.removeClass("show"); }, 2000);
		}
	
	var DISTANCE = function(p1, p2){
            
         return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2))
    }
	
	function STRING_FROM_DATE(date){

	var day = date.toLocaleString('en-us', { weekday: 'short'});

	var mod_string = "am";
	var hours = date.getHours();

	if(hours > 12){
		hours -= 12;
		mod_string = "pm";
	}
	if(hours == 12) mod_string = "pm";
	if(hours == 00) hours = 12;

	var mins = date.getMinutes();
	if(mins < 10) mins = "0" + mins;

	return day + " " + hours + ":" + mins + " " + mod_string;
}

    function TIMESTRING(){
        
        var today = new Date();
        var month = today.getMonth() + 1;
        if(month < 10) month = "0" + month;
        var day = today.getDate();
        if(day < 10) day = "0" + day;
        
      return today.getFullYear() + "" + month + "" + day;
        
    }
	
	function COPY(text){
		
		var node = $("#copytext");
		node.val(text);
		node[0].focus();
		node[0].select();
		document.execCommand("copy");
	}
	
	function INDEX_FUNC_FROM_EXPRESSION(str){
		
		var str = str.replace(/\s+/g, '');
		var f = function(index){

			eval(this.expression.replaceAllEWS("#", index));
			result = Math.round(result);			
			
			return (result < 10 ? "0" : "") +  result;
		}
		f = f.bind({expression: 'var result = ' + str});
		
		return f;
	}
	
	function SMART_EXPRESSION(str){
		
		var str = str.replace(/\s+/g, '');
		
		var txt_to_f = {};
		var fi = 0;
		
		var exp_str = '';
		var i_start = -1;
		for(var i = 0, n = str.length; i < n; i++){
			
			if(str[i] == "{"){
				
				i_start = i;
			}
			else if(str[i] == "}"){
				
				var piece = str.substring(i_start + 1, i);
				
				if(piece == "D"){
				    
					exp_str += TIMESTRING();
				}
				else{
					
					var exp = INDEX_FUNC_FROM_EXPRESSION(piece);
					txt_to_f['???x=' + fi + '?'] = exp;
					exp_str += '???x=' + fi + '?';
					fi++;
				}
			
				i_start = -1;
				continue;
			}
			
			if(i_start == -1){
				
				exp_str += str[i];
			}
		}		
		
		var f = function(index){
			
			var str = this.base_str;
			
			for(var i = 0; i < this.num_exps; i++){
				
				var text = '???x=' + i + '?';
				str = str.replace(text, this.txt_to_f[text](index));
			}
			
			return str;
		}
		
		f = f.bind({base_str:exp_str, txt_to_f:txt_to_f, num_exps:fi})
		return f;
	}
	
	var color_count = 0, color_index = -1;
	function GET_NEXT_COLOR(){

		var base_cols= ["#c6516c","#d6967b","#48a0a3","#988a51","#9ec15e","#75bca5","#6a97b5","#375265","#3b7762","#be3d2c","#aa67b5","#e5893a"];
		color_index++;
		if(color_index == base_cols.length){

			color_index = 0;
			color_count++;
		}

		return base_cols[color_index];
	}
	
	var SHIFT_KEYDOWN = false;
	
	
	
	$(document).keydown(function (e) {
		if (e.keyCode == 16) {
			SHIFT_KEYDOWN = true;
		}
	});
	
	$(document).keyup(function (e) {
		if (e.keyCode == 16) {
			SHIFT_KEYDOWN = false;
		}
	});
	
	
	var MOUSEDOWN = false;
	var MOUSE_START = null;
	var DRAG_ACTIVE = false;
	var DRAG_ROW = null;
	var ORIGINAL_ROW = null;
	
	$("body").on("mousedown", function(e){
		
		MOUSEDOWN = true;
		MOUSE_START = {x:e.clientX, y:e.clientY};
		
		var row = $(".injection.mouseover");
		if(row.length == 0) return;
		
		$("body").on("mousemove", function(e){
		
			var POINT = {x:e.clientX, y:e.clientY};

			if(!DRAG_ACTIVE && MOUSEDOWN && DISTANCE(MOUSE_START, POINT) > 5){

				var row = $(".injection.mouseover");

				if(row.length > 0){

					DRAG_ACTIVE = true;
					ORIGINAL_ROW = row;
					DRAG_ROW = $('<table id = "DRAG_ROW" class = "injection_list collapsed">');
					DRAG_ROW.css("width", $("#global_inj_table").width() + "px");
					DRAG_ROW.append(row.clone());
					DRAG_ROW.find("td").each(function(){
						
						$(this).css("width", row.find("td").eq($(this).index()).width() + "px");
					}) 
					
					$("body").append(DRAG_ROW);
					$("body").addClass("drag_active");

					var rect = row[0].getBoundingClientRect();
					var x = rect.left - POINT.x;
					var y = rect.top - POINT.y;

					DRAG_ROW.attr("data-dx", x);
					DRAG_ROW.attr("data-dy", y);

					ORIGINAL_ROW.addClass("moving");
				}
			}

			if(DRAG_ACTIVE){

				var x = parseFloat(DRAG_ROW.attr("data-dx")) + POINT.x;
				var y = parseFloat(DRAG_ROW.attr("data-dy")) + POINT.y;

				DRAG_ROW.css({left:x + "px",top:y + "px"});

				var row = $("#global_inj_table .injection.mouseover");

				if(row.length > 0){

					var rect = row[0].getBoundingClientRect();
					if(POINT.y > (rect.top + 0.5*rect.height)) ORIGINAL_ROW.insertAfter(row);
					else ORIGINAL_ROW.insertBefore(row);
				}
			}
		})
	})

	$("body").on("mouseup", function(e){
		
		MOUSEDOWN = false;
		
		var POINT = {x:e.clientX, y:e.clientY};
		
		if(DRAG_ACTIVE){
			
			ORIGINAL_ROW.removeClass("moving");
			ORIGINAL_ROW.trigger("movedidfinish")
			ORIGINAL_ROW = null;
			DRAG_ACTIVE = false;
			MOUSE_START = null;
			DRAG_ROW.remove();
			DRAG_ROW = null;
			
			$("body").removeClass("drag_active");
		}
		
		$("body").off("mousemove");
	})
	
	
	
	function R_id(){
		
		return parseInt(((new Date().getTime())).toFixed(0) + Math.floor(Math.random()*(999-100+1)+100));
	}
	
	
	function EventDispatcher(){
		
		this.listeners = {};
	}
	
	EventDispatcher.prototype.on = function(name, func){
		
		if(this.listeners[name] == undefined) this.listeners[name] = [];
		this.listeners[name].push(func);
	}
	
	EventDispatcher.prototype.off = function(name){
		
		this.listeners[name] = [];
	}
	
	EventDispatcher.prototype.fire = function(name, event_data){
		
		if(this.listeners[name] == undefined) return;
		
		for(var f of this.listeners[name]) f.call(this, event_data);
	}
	
	
	function WellSelector(){
		
		var _this = this;
		
		this.node = $('<div class="well_selector"></div>');
		this.node.on("click", function(e){
			
			e.stopPropagation();
		})
		
		var row = $('<div class = "row"></div>');
		
		var html = '<select>';
		html += '<option value="R">R</option>';
		html += '<option value="G">G</option>';
		html += '<option value="B">B</option>';
		html += '<option value="Y">Y</option>';
		html += '</select>';
		
		row.append($(html));
		this.node.append(row);
		
		for(var r = 0; r < 6; r++){
			
			var row = $('<div class = "row"></div>');
			
			for(var c = 1; c <= 9; c++){
				
				var pos = String.fromCharCode(65 + r) + c;
				var well = $('<div class = "well_option" data-position="' + pos + '">' + pos + '</div>');
				well.on("click", function(){
					
					var p = _this.node.find("option:selected").val() +  ":" + $(this).attr("data-position");
					_this.fire("change", {position:p});
					_this.dismiss();
				})
				row.append(well);
			}
			this.node.append(row);
		}
		
		EventDispatcher.call(this);
	}
	WellSelector.prototype = Object.create(EventDispatcher.prototype);
	
	WellSelector.prototype.displayForInput = function(input){
		
		var r = input.node[0].getBoundingClientRect();
		var x = r.left;
		if(x + this.node.width() > $(window).width()){
			
			x = r.left + r.width - this.node.width();
		}
		var y = r.top;
		if(y + this.node.height() > $(window).height()){
			
			y = r.top + r.height - this.node.height();
		}
		
		this.node.css({left:x + "px", top:y + "px"});
		this.node.addClass("visible");
	}
	
	WellSelector.prototype.setSelect = function(position){
		
		this.node.find(".selected").removeClass("selected");
		
		var p = position.split(":");
		
		this.node.find('option[value="' + p[0] + '"]').prop('selected', true);
		this.node.find('.well_option[data-position="' + p[1] + '"]').addClass("selected")
		this.node.find("option:selected")
	}
	
	WellSelector.prototype.dismiss = function(){
		
		this.node.removeClass("visible");
	}
	
	var WELL_SELECTOR = new WellSelector();
	$("#inj_area").append(WELL_SELECTOR.node);
	$("body").on("click", function(e){
			
			WELL_SELECTOR.dismiss();
	})
	
	
	function WellSelectorInput(){
	
		var _this = this;
		
		this.node = $('<div class = "well_selector_input"></div>');
		this.node.on("click", function(e){
			
			WELL_SELECTOR.setSelect(_this.node.html());
			WELL_SELECTOR.displayForInput(_this);
			WELL_SELECTOR.off("change");
			WELL_SELECTOR.on("change", function(e){
				
				_this.node.html(e.position);
				_this.fire("change", {data:e.position});
			});
			
			e.stopPropagation();
		})
		
		EventDispatcher.call(this);
	}
	WellSelectorInput.prototype = Object.create(EventDispatcher.prototype);
	
	WellSelectorInput.prototype.addToNode = function(node){
		
		node.append(this.node);
	}
	
	WellSelectorInput.prototype.setWell = function (well){
		
		this.node.html(well.getGlobalPosition());
	}
	
	
	function Sample(n, c){
		
		this.id = R_id();
		this.name = n;	
		this.color = c;
		
		EventDispatcher.call(this);
	}
	Sample.prototype = Object.create(EventDispatcher.prototype);
	
	Sample.prototype.setColor = function(c){
		
		this.color = c;
		this.fire("colorchange", {sample:this, color:c})
	}
	
	Sample.prototype.setName = function(n){
		
		this.name = n;
		this.fire("namechange", {sample:this, name:n})
	}
	
	Sample.prototype.getColor = function(){
		
		return this.color;
	}
	
	Sample.prototype.getName = function(){
		
		return this.name;
	}
	
	
	
	function Well(position){
		
		var _this = this;
		this.id = R_id();
		this.plate = null;
		this.position = position;
		this.sample = null;
		this.node = $('<div class = "well" data-inject-count = "0" data-position = "'+ position +'"><div class="indicator">'+ position +'</div></div>');
		this.selected = false;
		this.inject_count = 0;
		
		this.node.on("mousedown", function(){
			
			if(_this.isSelected()){
				_this.deselect();
				_this.fire("clickdeselect", {well:_this})
			}
			else{
				
				_this.fire("clickselect", {well:_this})
				_this.select();
			}
		})
		
		this.node.on("mouseenter", function(){
			
			if(MOUSEDOWN){
				
				if(!_this.isSelected()){

					_this.fire("clickselect", {well:_this})
					_this.select();
				}
			}
		})
	
		EventDispatcher.call(this);
	}
	Well.prototype = Object.create(EventDispatcher.prototype);
	
	Well.prototype.addToPlate = function(plate){
		
		this.plate = plate;
	}
	
	Well.prototype.addToNode = function(node){
		
		node.append(this.node);
	}
	
	Well.prototype.setSample = function(s){
		
		var _this = this;
		
		if(this.sample == null) this.fire("addsample", {well:_this});
		
		this.sample = s;
		this.node.attr("data-samplename", this.sample.name);
		this.node.css("background", this.sample.color);
		this.fire("setnewsample", {well:this, sample:s})
		
		this.sample.on("namechange", function(e){
			
			_this.node.attr("data-samplename", e.name);
			_this.fire("samplenamechange", {well:_this, sample:e.sample})
		})
	}
	
	
	Well.prototype.removeSample = function(){
		
		if(this.sample == null) return;
		
		this.sample = null;
		this.fire("removesample", {well:this});
		this.node.removeAttr("data-samplename");
		this.node.css("background", "");
	}
	
	Well.prototype.getSample = function(){
		
		return this.sample;
	}
	
	Well.prototype.getLocalPosition = function(){
		
		return this.position;
	}
	
	Well.prototype.getGlobalPosition = function(){
		
		return this.plate.getName() + ":" + this.position;
	}
	
	Well.prototype.changeInjectCountBy = function (delta){
		
		this.inject_count += delta;
		if(this.inject_count > 3){
			
			this.node.addClass("multi_inject");
		}else{
			
			this.node.removeClass("multi_inject");
		}
		this.node.attr("data-inject-count", this.inject_count);
	}
	
	Well.prototype.select = function(){
		
		if(this.selected) return;
			
		this.node.addClass("selected");
		this.selected = true;
		this.fire("select", {well:this});
	}
	
	Well.prototype.addClass = function(c){
		
		this.node.addClass(c);
	}
	
	Well.prototype.removeClass = function(c){
		
		this.node.removeClass(c);
	}
	
	Well.prototype.deselect = function(){
		
		if(!this.selected) return;
		
		this.node.removeClass("selected");
		this.selected = false;
		this.fire("deselect", {well:this});
	}
	
	Well.prototype.isSelected = function(){
		
		return this.selected;
	}
	
	Well.prototype.equals = function(well){
		
		return this.id == well.id;
	}
	
	function Injection(exp_id, well, vol){
		
		var _this = this;
		
		this.id = R_id();
		this.experiment_id = exp_id;
		this.volume = vol;
		
		this.selected = false;
		
		this.node = $('<tr class = "injection" data-id = "' + this.id  + '"></tr>');
		this.node.append($('<td class = "index"></td>'));
		this.node.append($('<td><input type = "checkbox"></td>'));
		this.node.append($('<td class = "exp_id">' + this.experiment_id + '</td>'));
		this.node.append($('<td class = "sample_name"></td>'))
		this.node.append($('<td class = "well_id"></td>'))
		this.node.append($('<td class = "vol"><input type = "number" min = "1" max = "20" value="'+ vol +'" ></td>'));
		this.node.bind("movedidfinish", function(){
			
			_this.fire("move", {injection:this});
		})
		
		this.node.on("mouseenter", function(){
			
			_this.node.addClass("mouseover");
			
		}).on("mouseleave", function(){
			
			_this.node.removeClass("mouseover");
		});
		
		this.node.find('input[type="checkbox"]').on("change", function(){
			
			if($(this).is(":checked")){
				
				_this.fire("clickselect", {injection:this});
				_this.select();
			}else{
				
				_this.deselect();
			}
		})
		
		this.node.find('input[type="number"]').on("change", function(){
			
			_this.setVolume($(this).val());
		})
		
		this.well_si = new WellSelectorInput();
		this.well_si.addToNode(this.node.find(".well_id"));
		this.well_si.on("change", function(e){
			
			var p = e.data;;
			_this.setWell(GLOBAL_PLATE_MANAGER.getWell(p));
		});
		
		this.setWell(well);
		
		EventDispatcher.call(this);
	}
	Injection.prototype = Object.create(EventDispatcher.prototype);
	
	Injection.prototype.setWell = function(well){
		
		var _this = this;
		
		if(this.well) this.well.changeInjectCountBy(-1);
		this.well = well;
		this.well.changeInjectCountBy(1);
		this.well.on("setnewsample", function(e){
			
			_this.refresh();
		})
		
		this.well.on("removesample", function(e){
			
			_this.refresh();
		});
		
		this.well.on("samplenamechange", function(e){
			
			_this.refresh();
		});
		
		this.well_si.setWell(well);

		this.refresh();
	}
	
	Injection.prototype.getWell = function(){
		
		return this.well;
	}
	
	Injection.prototype.setIndex = function(index){
		
		this.node.find(".index").html(index);
	}
	
	Injection.prototype.setVolume = function(v){
		
		this.volume = v;
		this.node.find('input[type="number"]').val(this.volume);
	}
	
	Injection.prototype.setExperimentID = function(id){
		
		this.experiment_id = id;
		this.node.find('.exp_id').html(this.experiment_id);
	}
	
	Injection.prototype.changeVolume = function(delta_v){
		
		this.setVolume(this.volume + delta_v);
	}
	
	Injection.prototype.select = function(){
		
		this.node.find('input:checkbox').prop("checked", true);
		this.node.addClass("selected");
		
		this.selected = true;
	}
	
	Injection.prototype.deselect = function(){
		
		this.node.find('input:checkbox').prop("checked", false);
		this.node.removeClass("selected");
		
		this.fire("deselect", {injection:this});
		this.selected = false;
	}
	
	Injection.prototype.isSelected = function(){
		
		return this.selected;
	}
	
	Injection.prototype.addToNode = function(node){
		
		node.append(this.node);
	}
	
	Injection.prototype.remove = function(){
		
		this.well.changeInjectCountBy(-1);
		this.node.remove();
	}
	
	Injection.prototype.refresh = function(){
		
		var sample = this.well.getSample();
		
		var sn = sample == null ? "" : sample.getName();
		this.node.find(".sample_name").html(sn);
		
		var c = sample == null ? "none" : sample.getColor();
		this.node.find(".sample_name").css("background", c);
	}
	
	Injection.prototype.copy = function(){
		
		return new Injection(this.experiment_id, this.well, this.volume);
	}
	
	Injection.prototype.getData = function(){
		
		var sample = this.well.getSample();
		var name = sample == null ? "": sample.getName(); 
		
		return {exid:this.experiment_id, sn:name, pos:this.well.getGlobalPosition(), vol:this.volume};
	}
	
	
	
	
	
	function Plate(config){
		
		var _this = this;
		this.node = $('<div data-select-well-count = "0" data-sample-count = "0" class = "plate"></div>');
		this.name = config.name;
		this.wells = {};
		this.nrows = config.rows;
		this.ncols = config.columns;
		this.last_selected_well = null;
		this.select_well_count = 0;
		this.sample_count = 0;
		
		var index = 0;
		for(var r = 0; r < config.rows; r++){
			
			var row = $('<div class = "row"></div>');
			
			for(var c = 1; c <= config.columns; c++){
				
				var pos = String.fromCharCode(65 + r) + c;
				var well = new Well(pos);
				well.addToPlate(this);
				well.addToNode(row);
				this.wells[pos] = well;
				this.wells[index] = well;
				well.on("clickselect", function(e){
					
					_this.wellWasClickSelected(e.well);
				})
				well.on("clickdeselect", function(e){
					
					_this.wellWasClickDeselected(e.well);
				})
				well.on("select", function(e){
					
					_this.wellWasSelected(e.well);
				})
				well.on("deselect", function(e){
					
					_this.wellWasDeSelected(e.well);
				})
				well.on("removesample", function(e){
					
					_this.sampleWasRemovedFromWell(e.well);
				})
				well.on("addsample", function(e){
					
					_this.sampleWasAddedToWell(e.well);
				})
				
				index++;
			}
			this.node.append(row);
		}
		
		this.node.css("border-left", "20px solid " + config.color);
	}
	
	Plate.prototype.getName = function(){
		
		return this.name;
	}
	
	Plate.prototype.getWell = function(pos){
			
		return this.wells[pos];
	}
	
	Plate.prototype.getAllWells = function(pos){
			
		var wells = [];
			
		for(var i = 0, n = this.ncols*this.nrows; i < n; i++){
			
			wells.push(this.wells[i]);
		}
		
		return wells;
	}
	
	Plate.prototype.indexFromPosition = function(pos){
	
		var ri = pos[0].charCodeAt(0) - 65;
		return ri*this.ncols + (parseInt(pos[1]) - 1);
	}
	
	Plate.prototype.positionFromIndex = function(index){
		
		var r = Math.floor(index/this.ncols);
		var c = index%this.ncols + 1;
		return String.fromCharCode(65 + r) + c;
	}
	
	Plate.prototype.sampleWasAddedToWell = function(well){
		
		this.sample_count++;
		this.node.attr("data-sample-count", this.sample_count);
	}
	
	Plate.prototype.sampleWasRemovedFromWell = function(well){
		
		this.sample_count--;
		this.node.attr("data-sample-count", this.sample_count);
	}
	
	Plate.prototype.wellWasSelected = function(well){
		
		this.select_well_count++;
		this.node.attr("data-select-well-count", this.select_well_count);
	}
	
	Plate.prototype.wellWasDeSelected = function(well){
		
		this.select_well_count--;
		this.node.attr("data-select-well-count", this.select_well_count);
	}
	
	Plate.prototype.wellWasClickSelected = function(well){
			
		if(this.last_selected_well) this.last_selected_well.removeClass("last");
		this.last_selected_well = well;
		this.last_selected_well.addClass("last");
		
		if(SHIFT_KEYDOWN == false) return;
		
		var min_d = 1e4, min_index = -1, index = this.indexFromPosition(well.getLocalPosition());
		
		for(var i = 0, n = this.ncols*this.nrows; i < n; i++){
			
			if(i != index && this.wells[i].isSelected()){
				
				var d = Math.abs(index - i)
				if(d < min_d){
					
					min_d = d;
					min_index = i;
				}
			}
		}
		
		if(min_index < 0) return;
		
		var start = Math.min(index, min_index), end = Math.max(index, min_index);
		for(var i = start; i <= end; i++)this.wells[i].select();
	}
	
	Plate.prototype.wellWasClickDeselected = function(well){
			
		if(this.last_selected_well == well){
			
			this.last_selected_well.removeClass("last");
			this.last_selected_well = null;
		}
	}
	
	Plate.prototype.deselectAllWells = function(){
			
		for(var i = 0, n = this.ncols*this.nrows; i < n; i++){
			
			if(this.wells[i].isSelected()) this.wells[i].deselect();
		}
		
		if(this.last_selected_well) this.last_selected_well.removeClass("last");
		this.last_selected_well = null;
	}
	
	Plate.prototype.getLastSelectedWell = function(){
		
		return this.last_selected_well;
	}
	
	Plate.prototype.getAllSelectedWells = function(){
		
		var sel_wells = [];
			
		for(var i = 0, n = this.ncols*this.nrows; i < n; i++){
			
			if(this.wells[i].isSelected()) sel_wells.push(this.wells[i]);
		}
		
		return sel_wells;
	}
	
	Plate.prototype.shiftSelection = function(direction){
			
		if(direction == 1){
			
			var s = [], ns = [];
			
			for(var i = 0, n = this.ncols*this.nrows; i < n; i++){
			
				if(this.wells[i].isSelected()){
					
					s.push(i);
					this.wells[i].deselect();	
				}
				else ns.push(i);
			}
			
			for(var i = 0, n = s.length; i < n; i++){
				
				var sindex = s[i];
				for(var i2 = 0, n2 = ns.length; i2 < n2; i2++){
				
					var nsindex = ns[i2];
					if(nsindex > sindex){
						
						this.wells[nsindex].select();
						ns.splice(i2, 1);
						break;
					}
				}
			}
		}
	}
	
	Plate.prototype.removeSamplesFromAllSelectedWells = function(){
			
		for(var i = 0, n = this.ncols*this.nrows; i < n; i++){
			
			if(this.wells[i].isSelected()) this.wells[i].removeSample();
		}
	}
	
	Plate.prototype.addToNode = function(node){
			
		node.append(this.node);	
	}
	
	
	function PlateManager(node){
		
		this.node = node;
		this.plates = [];
		this.npm = {}
	}
	PlateManager.prototype.addPlate = function(plate){
		
		this.plates.push(plate);
		this.npm[plate.name] = plate;
		
		plate.addToNode(this.node);
		plate.node.on("paste", function(e){
		
			 var ptxt = e.originalEvent.clipboardData.getData('text/plain');
			 var index = plate.indexFromPosition(plate.getLastSelectedWell().getLocalPosition());
			 ptxt = ptxt.replace(/ /g, "-")
			 var sample_names = ptxt.split(/\s+/);
			 var colmap = {}

			 for(var name of sample_names){

				var rep_name = name.substr(0, name.lastIndexOf("-"));
				if(colmap[rep_name] == undefined) colmap[rep_name] = GET_NEXT_COLOR();
				plate.getWell(index).setSample(new Sample(name, colmap[rep_name]));
				index++;
			 }

			e.preventDefault();
		})
		plate.node.on("copy", function(e){
		
			var well = plate.getLastSelectedWell();
			if(well == null) well = plate.getAllSelectedWells()[0];
			if(well == null) return;
		
			var sample = well.getSample();
			if(sample == null) return;
		
			COPY(sample.getName());
		})
		
	}
	
	PlateManager.prototype.getPlate = function(name){
		
		return this.npm[name];
	}
	
	PlateManager.prototype.getWell = function(position){
		
		var comps = position.split(":");
		return this.npm[comps[0]].getWell(comps[1]);
	}
	
	PlateManager.prototype.clearAllSelections = function(){
		
		for(var plate of this.plates) plate.deselectAllWells();
	}
	
	PlateManager.prototype.getAllSelectedWells = function(){
		
		var wells = [];
		
		for(var plate of this.plates) wells = wells.concat(plate.getAllSelectedWells());
		
		return wells;
	}
	
	PlateManager.prototype.removeSamplesFromAllSelectedWells = function(){
		
		 for(var plate of this.plates) plate.removeSamplesFromAllSelectedWells();
	}
	
	PlateManager.prototype.showSampleNames = function(){
		
		 for(var plate of this.plates) plate.node.addClass("show_names");
	}
	
	PlateManager.prototype.hideSampleNames = function(){
		
		 for(var plate of this.plates) plate.node.removeClass("show_names");
	}
	
	PlateManager.prototype.editAllSampleNames = function(mode, search, insert){
		
		 for(var plate of this.plates) {
					
			var wells = plate.getAllWells();
			for(var w of wells){

				var sample = w.getSample();
				if(sample == null) continue;

				var name = sample.getName();
				
				var next_text = insert;

				if(mode == "before") next_text = insert + search;
				else if(mode == "after") next_text = search + insert;

				sample.setName(name.replaceAllEWS(search, next_text));
			}
		}
	}
	
	PlateManager.prototype.shiftAllPlateSelections = function(direction){
		
		for(var plate of this.plates) plate.shiftSelection(direction);
	}
	
	
	function InjectionList(){
	
		var _this = this;
		
		this.node = $('<table id = "global_inj_table" class= "injection_list collapsed"></table>');
		this.injections = [];
		this.map_id_to_inj = {};
		this.add_mode = "end";
		
		EventDispatcher.call(this);
	}
	InjectionList.prototype = Object.create(EventDispatcher.prototype);
	
	InjectionList.prototype.addToNode = function(node){
		
		node.append(this.node);
	}
	
	InjectionList.prototype.setAddMode = function(mode){
		
		this.add_mode = mode;
	}
	
	InjectionList.prototype.addInjection = function(injection, index){
		
		var _this = this;
		
		injection.on("clickselect", function(e){
			
			_this.injectionWasClickSelected(injection);
		})
		
		injection.on("move", function(e){
			
			_this.reIndex();
		})
		
		if(index == undefined){
			
			if(this.add_mode == "start"){
			
				index = 0;
			}
			else if(this.add_mode == "end"){
				
				index = this.injections.length;
			}
			else if(this.add_mode == "before selection"){

				var i = 0;
				for(; i < this.injections.length; i++)if(this.injections[i].isSelected()) break;
				index = i;
			}
			else if(this.add_mode == "after selection"){

				var i = this.injections.length - 1;
				for(; i >= 0; i--) if(this.injections[i].isSelected()) break;
				index = i + 1;
			}
		}
		
		
		if(index == this.injections.length){
				
			this.injections.push(injection);
			injection.addToNode(this.node);
		}
		else{
				
			injection.node.insertBefore(this.injections[index].node);
			this.injections.splice(index, 0, injection);
		}
		
		for(var i = this.injections.length -1; i >= 0; i--){
		
			this.injections[i].setIndex(i + 1);
		}
		
		this.map_id_to_inj[injection.id] = injection;
		this.fire("nchange",{list:this});
	}
	
	InjectionList.prototype.count = function(){
		
		return this.injections.length;
	}
	
	InjectionList.prototype.reIndex = function(){
		
		var _this = this;
		var injections = [];
		var index = 1;
		
		this.node.find(".injection").each(function(){
			
			var i = _this.map_id_to_inj[$(this).attr("data-id")];
			i.setIndex(index);
			injections.push(i);
			index++;
		})
		
		this.injections = injections;
	}
	
	InjectionList.prototype.injectionWithId = function(id){
		
		return this.map_id_to_inj[id];
	}
	
	InjectionList.prototype.selectInjectionsFromWell = function(well){
		
		for(var i = this.injections.length -1; i >= 0; i--){
		
			var injection = this.injections[i];
			if(injection.getWell().equals(well)){
				
				injection.select();
			}
		}
	}
	
	InjectionList.prototype.selectedInjections = function(){
		
		var selected = [];
		
		for(var inj of this.injections)if(inj.isSelected()) selected.push(inj);
		
		return selected;
	}
	
	InjectionList.prototype.injectionWasClickSelected = function(injection){
		
		this.fire("nselectchange", {list:this});
		
		if(SHIFT_KEYDOWN == false) return;
		
		var index = injection.node.index();
		var min_distance = 1e3, min_index = -1;
		
		this.node.find(".selected").each(function(e){
			
			var d = Math.abs($(this).index() - index);
			if(d < min_distance){
				
				min_index = $(this).index();
				min_distance = d;
			}
		});
		
		if(min_index < 0) return;
		
		var start = Math.min(index, min_index), end = Math.max(index, min_index);
		for(var i = start; i <= end; i++)this.injections[i].select();
	}
	
	InjectionList.prototype.deleteSelectedInjections = function(){
		
		for(var i = this.injections.length -1; i >= 0; i--){
		
			var injection = this.injections[i];
			if(injection.isSelected()) injection.remove();
		}
		
		this.reIndex();
		this.fire("nchange",{list:this});
	}
	
	InjectionList.prototype.duplicateSelectedInjections = function(){
		
		for(var i = this.injections.length -1; i >= 0; i--){
		
			var injection = this.injections[i];
			if(injection.isSelected()) this.addInjection(injection.copy(), i);
		}
	}
	
	InjectionList.prototype.deselectAllInjections = function(){
		
		for(var i = this.injections.length -1; i >= 0; i--){
		
			this.injections[i].deselect();
		}
	}
	
	InjectionList.prototype.selectAllInjections = function(){
		
		for(var i = this.injections.length -1; i >= 0; i--){
		
			this.injections[i].select();
		}
	}

	
	
	
	function Experiment(str){
		
		this.date_string = TIMESTRING();
		
		if(str == undefined){
			
			this.project = "";
			this.title = "";
			this.last_name = "";
			this.method_path = "";
			this.output_path = "";
		}
		else{
			
			this.setValuesWithDataString(str);
		}
	}
	
	Experiment.prototype.hasValuesForAllFields = function(){
		
		var keys = Object.keys(this);
		for(var key of keys){
		    
		    var val = this[key];
		    if(typeof val === 'string' && val.trim() == "") return false;
		}
		
		return true;
	}
	
	Experiment.prototype.setID = function(id){
		
		this.id = id;
	}
	
	Experiment.prototype.getID = function(){
		
		return this.id;
	}
	
	Experiment.prototype.setValuesWithDataString = function(str){
		
		var comps = str.split("???");
		this.project = comps[0];
		this.title = comps[1];
		this.last_name = comps[2];
		this.method_path = comps[3];
		this.output_path = comps[4];
	}
	
	Experiment.prototype.getDataString = function(){
		
		var str = "";
		str += this.project + "???";
		str += this.title + "???";
		str += this.last_name + "???";
		str += this.method_path + "???";
		str += this.output_path;
		
		return str;
	}
	
	Experiment.prototype.getShortString = function(){
		
		return this.project + " / " + this.last_name + " / " + this.title;
	}
	
	Experiment.prototype.copy = function(){
		
		var new_ex = new Experiment();
		new_ex.project = this.project;
		new_ex.title = this.title
		new_ex.date_string = this.date_string;
		new_ex.last_name = this.last_name;
		new_ex.method_path = this.method_path;
		new_ex.output_path = this.output_path;
		
		return new_ex;
	}
	
	
	
	function ExperimentManager(id_selector, input, output){
		
		var _this = this;
		this.id_selector = id_selector;
		this.input_node = input;
		this.output_node = output;
		this.active_experiment = null;
		
		this.id_selector.on("change", function(e){
		
			var opt = $(this).find("option:selected");
			var value = opt.val()
			_this.setActiveExperiment(parseInt(value));
		})
		
		this.input_node.on("click", function(e){
		
			_this.displayEditPanelForActiveExperiment();
			e.stopPropagation();
		});
		
		this.output_node.find("input").on("change", function(){

			_this.updateActiveExpriment();
		})
		
		this.output_node.on("click", function(e){
		
			e.stopPropagation();
		})
		
		this.experiments = [];
	}
	
	ExperimentManager.prototype.addExperiment = function (exp){
		
		var id = this.experiments.length;
		exp.setID(id);
		var new_opt =$('<option value="' + id + '">'+ id + ": " + exp.getShortString() + '</option>');
		this.id_selector.append(new_opt);
		return this.experiments.push(exp);
	}
	
	ExperimentManager.prototype.getExperimentWithID = function (id){
		
		return this.experiments[id];
	}
	
	ExperimentManager.prototype.setActiveExperiment = function(id){
		
		this.active_experiment = this.experiments[id];
		this.input_node.html(this.active_experiment.getShortString());
		this.displayEditPanelForActiveExperiment();
		this.id_selector.find('option[value="' + id + '"]').prop('selected', true)
	}
	
	ExperimentManager.prototype.getActiveExperiment = function(id){
		
		return this.active_experiment;
	}
	
	ExperimentManager.prototype.cloneActiveExperiment = function(){
		
		var new_exp = this.active_experiment.copy();
		return this.addExperiment(new_exp) - 1;
	}
	
	ExperimentManager.prototype.displayEditPanelForActiveExperiment = function(){	
		
		var exp = this.active_experiment;
		
		this.output_node.find("#pi").val(exp.project);
		this.output_node.find("#di").val(exp.date_string);
		this.output_node.find("#eli").val(exp.last_name);
		this.output_node.find("#eti").val(exp.title);
		this.output_node.find("#ofpi").val(exp.output_path);
		this.output_node.find("#mfpi").val(exp.method_path);
		
		var rect = this.input_node[0].getBoundingClientRect();
		this.output_node.css({"left":rect.left+"px", "top":rect.top+"px", "width":rect.width+"px"});
		this.output_node.addClass("visible");
	}
	
	ExperimentManager.prototype.updateActiveExpriment = function(){
		
		this.active_experiment.project = this.output_node.find("#pi").val();
		this.active_experiment.date_string = this.output_node.find("#di").val();
		this.active_experiment.last_name = this.output_node.find("#eli").val();
		this.active_experiment.title = this.output_node.find("#eti").val();
		this.active_experiment.output_path = this.output_node.find("#ofpi").val();
		this.active_experiment.method_path = this.output_node.find("#mfpi").val();
		
		var id = this.active_experiment.getID();
		var str = this.active_experiment.getShortString();
		this.id_selector.find('option[value="' + id + '"]').html(id + ": " + str);
		this.input_node.html(str);
	}
	
	ExperimentManager.prototype.saveAllExperiments = function(){
		
		var n = this.experiments.length;
		localStorage.setItem("num_exps", this.experiments.length);
		
		for(var i = 0; i < n; i++){
			
			localStorage.setItem("exp_" + i, this.experiments[i].getDataString());
		}
	}
	
	ExperimentManager.prototype.restoreAllSavedExperiments = function(){
		
		var num_exps = localStorage.getItem("num_exps");
		if(num_exps == undefined) return;
		
		num_exps = parseInt(num_exps);
		
		for(var i = 0; i < num_exps; i++){
			
			var dstring = localStorage.getItem("exp_" + i);
			var exp = new Experiment(dstring);
			this.addExperiment(exp);
		}
		
		if(this.experiments.length == 0) this.addExperiment(new Experiment());
		this.setActiveExperiment(0);
	}
	
	
	
	function UPDATE_SEQ_END_TIME(){

		var min = parseInt($("#min_per_inj_input").val())*GLOBAL_INJECTION_LIST.count();
		var d = Date.parse($("#seq_start_time").attr("data-actual_date"));
		var end_date = new Date(d + 60000*min);	
		$("#seq_end_time").html(STRING_FROM_DATE(end_date));
	}
	
	
	var GLOBAL_PLATE_MANAGER = new PlateManager($("#plate_container"));
	GLOBAL_PLATE_MANAGER.addPlate(new Plate({name:"R", color:"#b53232", rows:6, columns:9}));
	GLOBAL_PLATE_MANAGER.addPlate(new Plate({name:"G", color:"#407b56", rows:6, columns:9}));
	GLOBAL_PLATE_MANAGER.addPlate(new Plate({name:"B", color:"#30487e", rows:6, columns:9}));
	GLOBAL_PLATE_MANAGER.addPlate(new Plate({name:"Y", color:"#ebde41", rows:6, columns:9}));	
	
	
	
	var GLOBAL_INJECTION_LIST = new InjectionList();
	GLOBAL_INJECTION_LIST.addToNode($(".inj_container"));
	GLOBAL_INJECTION_LIST.on("nchange", function(e){
		
		$("#inj_count").html(e.list.count());
		UPDATE_SEQ_END_TIME();
	})
	
	$("#min_per_inj_input").on("change", function(){
		
		UPDATE_SEQ_END_TIME();
	})
	
	
	var sw = new WellSelector();
	
	
	$("#seq_start_time").html(STRING_FROM_DATE(new Date()));
	$("#seq_start_time").attr("data-actual_date", new Date().toUTCString());
	$("#seq_start_time").on("keydown", function(e){
		
		var keycode = (e.keyCode ? e.keyCode : e.which);
		if(keycode == 38 || keycode == 40){
			//up arrow
			var delta = 0;
			if(keycode == 38) delta = 10;
			else delta = -10;
			
			var d = new Date(Date.parse($(this).attr("data-actual_date")) + delta*60000);
			$(this).attr("data-actual_date", d.toUTCString());
			$(this).html(STRING_FROM_DATE(d));
			
			UPDATE_SEQ_END_TIME();
			
			e.preventDefault();
		}
	})
	
	
	
	
	UPDATE_SEQ_END_TIME();
	
	
	$("#set_vol_bttn").on("click", function(){
		
		var vol = $("#vol_input").val();
		var injections = GLOBAL_INJECTION_LIST.selectedInjections();
		for(var i of injections) i.setVolume(vol);
	})
	
	$("#vol_input").on("keydown", function(e){
	    
	    var keycode = (e.keyCode ? e.keyCode : e.which);
	    if(keycode == 13){
	        //enter
	        	var vol = $(this).val();
	           	var injections = GLOBAL_INJECTION_LIST.selectedInjections();
	        	for(var i of injections) i.setVolume(vol);
	    }
	})
	
	
	$("#set_epxid_bttn").on("click", function(){
		
		var id = $("#exp_id_input").val();
		var injections = GLOBAL_INJECTION_LIST.selectedInjections();
		for(var i of injections) i.setExperimentID(id);
	})
	
	$("#exp_id_input").on("keydown", function(e){
	    
	    var keycode = (e.keyCode ? e.keyCode : e.which);
	    if(keycode == 13){
	        //enter
	        	var id = $(this).val();
	           	var injections = GLOBAL_INJECTION_LIST.selectedInjections();
	        	for(var i of injections) i.setExperimentID(id);
	    }
	})
	
	$("#select_all_bttn").on("click", function(){
		
		GLOBAL_INJECTION_LIST.selectAllInjections();
	})
	
	$("#clr_select_bttn").on("click", function(){
		
		GLOBAL_INJECTION_LIST.deselectAllInjections();
	})
	
	$("#delete_bttn").on("click", function(){
		
		GLOBAL_INJECTION_LIST.deleteSelectedInjections();
	})
	
	$("#download_bttn").on("click", function(){
		 
		 var rows = [];
		 rows.push(["Bracket Type=4"]);
	     rows.push(["File Name","Path","Instrument Method","Position","Inj Vol"]);
		
		 var injections = GLOBAL_INJECTION_LIST.selectedInjections();
		 if (injections.length == 0){
			 
			GLOBAL_INJECTION_LIST.selectAllInjections();
			injections = GLOBAL_INJECTION_LIST.selectedInjections();
		 }
		
		 if (injections.length == 0) return;
		 
		 var name_counts = {};
		
		 for(var i of injections){
			
			 var data = i.getData();
			 var e = GLOBAL_EXP_MANAGER.getExperimentWithID(data.exid);
			 if (e.hasValuesForAllFields() == false){
				 
				 FLASH_STATUS_BAR('error', 'Could not download sequence. One or more injections was linked to an experiment missing values.');
				 return;
			 }

			 var filename = e.project + "_" + e.date_string + "_" + e.title + "_" + e.last_name + "_" + data.sn;
			 
			 if(name_counts[filename] == undefined ) name_counts[filename] = 1;
			 else name_counts[filename]++;
			 
			 var count = name_counts[filename]
			 if(count > 1)filename += "_i" + count;
			 
			 rows.push([filename, e.output_path, e.method_path, data.pos, data.vol]);
		 }
		 
		 var csv = Papa.unparse(rows);
		 var link = document.createElement('a');
		 link.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(csv));
		 link.setAttribute('download', TIMESTRING() + "_final_run_queue.csv");
		 link.style.display = 'none';

		 document.body.appendChild(link);
		 link.click();
		 document.body.removeChild(link);	  
	})
	
	$("#inj_mode_input").on("change", function(e){
		
		GLOBAL_INJECTION_LIST.setAddMode($(this).find("option:selected").text());
	})
	
    $("#inj_area").on("keydown", function(e){
			
		if(e.keyCode == 8) GLOBAL_INJECTION_LIST.deleteSelectedInjections();
		else if(e.keyCode == 27) GLOBAL_INJECTION_LIST.deselectAllInjections();
		else if(e.keyCode == 65 && SHIFT_KEYDOWN) GLOBAL_INJECTION_LIST.selectAllInjections();
		else if(e.keyCode == 187 && SHIFT_KEYDOWN) GLOBAL_INJECTION_LIST.duplicateSelectedInjections();
	});
	
	
	
	$("#help_bttn").on("click", function(){
	
		$("#help_section").toggleClass("visible");
	})

	
	
	 $("#plate_area").on("keydown", function(e){
			
		var keycode = (e.keyCode ? e.keyCode : e.which);
		if(keycode == 8){
			//backspace
			if(SHIFT_KEYDOWN){
				
				GLOBAL_INJECTION_LIST.deselectAllInjections();
				
				 var wells = GLOBAL_PLATE_MANAGER.getAllSelectedWells();
				 for(var w of wells){

					 GLOBAL_INJECTION_LIST.selectInjectionsFromWell(w);
				 }
				
				 GLOBAL_INJECTION_LIST.deleteSelectedInjections();
			}
			else{
					
				GLOBAL_PLATE_MANAGER.removeSamplesFromAllSelectedWells();
			}
		}
		 else if(keycode == 13){
			 //enter
			 if(SHIFT_KEYDOWN){
				 
				 var move = $("#move_select_post_add").is(':checked');
				 var exp_id = $("#exp_id_selector").find("option:selected").val();
				 var wells = GLOBAL_PLATE_MANAGER.getAllSelectedWells();
				
				 for(var w of wells){

					 if (w.getSample() != null){
						 
						  var i = new Injection(exp_id, w, 10);
						 GLOBAL_INJECTION_LIST.addInjection(i);
					 }
				 }

				 if(move) GLOBAL_PLATE_MANAGER.shiftAllPlateSelections(1);
			 }
		}
		else if(keycode == 27){
			//esc
			 GLOBAL_PLATE_MANAGER.clearAllSelections();
		}
	});
	
	
	$("#show_sample_names").on("change", function(){
		
		if($(this).prop("checked")) GLOBAL_PLATE_MANAGER.showSampleNames();
		else GLOBAL_PLATE_MANAGER.hideSampleNames();
	})
	
	
	$("#sample_name_input").on("keydown", function(e){
		
		 var keycode = (e.keyCode ? e.keyCode : e.which);
		 if(keycode == 16) return;
		 if(keycode == 13){
			 
			 if(SHIFT_KEYDOWN == false) ADD_SAMPLES_TO_ALL_SELECTED_WELLS(); 
		 }
		
		e.stopPropagation();
	});
	
	$("#add_sample_bttn").on("click", function(){
		
		ADD_SAMPLES_TO_ALL_SELECTED_WELLS();
	})
	
	
	function ADD_SAMPLES_TO_ALL_SELECTED_WELLS(){
		
		 var index = 1;
		 var color = GET_NEXT_COLOR();

		 var text = $("#sample_name_input").val();
		 text = text.replaceAllEWS("0.", "0p");
		 text = text.replace(/,/g, ";");
		 text = text.replace(/\//g, "");

		 var name_expression = SMART_EXPRESSION(text);

		 if(text.length > 2){

			 var move = $("#move_select_post_add").is(':checked');
			 var wells = GLOBAL_PLATE_MANAGER.getAllSelectedWells();
			 for(var w of wells){
				 

				w.setSample(new Sample(name_expression(index), color));	
				index++;
			 }

			 if(move) GLOBAL_PLATE_MANAGER.shiftAllPlateSelections(1);
		}	
	}
	
	$("#insert_input").on("keydown", function(e){
		
		var keycode = (e.keyCode ? e.keyCode : e.which);
		
		var mode = $("#ins_mode_input option:selected").text();
		var search_text = $("#search_input").val();
		var insert = $(this).val();
		
		if(keycode == 16) return;
		if(keycode == 13) GLOBAL_PLATE_MANAGER.editAllSampleNames(mode, search_text, insert);
	});	
	
	
	$("#insert_bttn").on("click", function(e){
		var mode = $("#ins_mode_input option:selected").text();
		var search_text = $("#search_input").val();
		var insert = $("#insert_input").val();
		
		GLOBAL_PLATE_MANAGER.editAllSampleNames(mode, search_text, insert);
	});	
	
	var GLOBAL_EXP_MANAGER = new ExperimentManager($("#exp_id_selector"), $("#exp_edit_input"), $("#exp_edit_panel"));
	GLOBAL_EXP_MANAGER.restoreAllSavedExperiments();
	
	$("#clone_exp_bttn").on("click", function(){
		
		var id = GLOBAL_EXP_MANAGER.cloneActiveExperiment();
		GLOBAL_EXP_MANAGER.setActiveExperiment(id);
	})
	
	$("body").on("click", function(){
		
		$("#exp_edit_panel").removeClass("visible");
	})

	window.onbeforeunload = function(event) {
		
		GLOBAL_EXP_MANAGER.saveAllExperiments();
	}

	$("#toggle_ctrl_bar").on("click", function(){
		
		$(this).toggleClass("on");
		$(".control_bar").toggleClass("show_lower");
	})
	
</script>
</body>
</html>